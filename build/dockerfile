FROM pgsdevops/pimcore-ubuntu-php74:v1.0

##########################SSH Access#######################
RUN echo "root:Docker!" | chpasswd \
#&& echo "cd /home" >> /etc/bash.bashrc \
&& apt-get update \
&&  apt-get install --yes --no-install-recommends openssh-server nfs-common

ENV APACHE_RUN_USER www-data
ENV APACHE_RUN_GROUP www-data
ENV APACHE_LOG_DIR /var/log/apache2
ENV APACHE_LOCK_DIR /var/lock/apache2
ENV APACHE_PID_FILE /var/run/apache2.pid
ENV PROJECT Pimcore
ENV APP_USER pimcore_user

RUN apt-get update && apt-get install -y  telnet
RUN apt-get update && apt-get install -y  zip
RUN apt-get update && apt-get install -y  dos2unix
RUN apt-get update && apt-get install -y  stunnel
RUN apt-get update && apt-get install -y  git
RUN apt-get update && apt-get install -y  wget
RUN apt-get update && apt-get install -y  apt-transport-https
RUN apt-get update && apt-get install -y  vim
RUN apt-get update && apt-get install -y  lynx
RUN apt-get update && apt-get install -y  ffmpeg
RUN apt-get update && apt-get install -y  php-imagick
RUN apt-get update && apt-get install -y  supervisor
RUN apt-get update && apt-get install -y  libgvpr2
RUN apt-get update && apt-get install -y  sudo
RUN apt-get update && apt-get install -y  awscli

EXPOSE 80 22

## Copy site into place.
#RUN aws s3 cp s3://testingjojo/app_latest.zip /var/www/html/app_latest.zip
ADD app_latest.zip /var/www/html
RUN cd /var/www/html/ && \
  unzip app_latest.zip && \
  rm /var/www/html/app_latest.zip


RUN rm -rf /var/www/html/.git*

RUN cd /var/www/html/build/config_files/ && \
#    cp parameters.yml /var/www/html/app/config/ && \
#    cp cli-php.ini /etc/php/7.4/cli/php.ini && \
#    cp apache-php.ini /etc/php/7.4/apache2/php.ini && \
    cp startup.sh /var/www/html/ && \
 #   cp pimcore.conf /etc/apache2/sites-enabled/ && \
    cp database.yml /var/www/html/app/config/local/ && \
    cp config.yml /var/www/html/app/config/ && \
#    cp services.yml /var/www/html/app/config/ && \
#    cp crontab.txt /tmp/crontab.txt 

RUN dos2unix /var/www/html/startup.sh
RUN ls -la /var/www/html

RUN cd /var/www/html/ && \
    chmod +x bin/console && \
    composer clear-cache && \
    COMPOSER_MEMORY_LIMIT=-1 composer install



## Update the default apache site with the config we created.
RUN cd /var/www/html/build/config_files/ && \
    cp apache2.conf /etc/apache2/apache2.conf && \
    cp 000-default.conf /etc/apache2/sites-enabled/ && \
     cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf && \
 #   cp config.yml /var/www/html/app/config/ 

CMD ["/usr/bin/supervisord"]
